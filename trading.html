<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Greenlet â€” Trading</title><link rel="stylesheet" href="style.css"><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script><script src="firebase.js"></script><script src="app.js"></script></head><body><script>renderSidebar()</script><div class="content"><div class="page-title">Trading</div><div class="panel form"><input id="searchUser" placeholder="Search username to trade with" /><button onclick="findUser()">Find</button><div id="found"></div></div><div id="offers" class="panel"></div></div><script>async function findUser(){const q=document.getElementById('searchUser').value.trim();if(!q) return alert('type username');const snap=await db.collection('users').where('username','==',q).get();if(snap.empty) return document.getElementById('found').innerText='No user';const doc=snap.docs[0];const uid=doc.id;document.getElementById('found').innerHTML='Found: '+doc.data().username + ' <button onclick="createOffer(\''+uid+'\')">Create Offer</button>';}async function createOffer(targetUid){requireAuth(async (me)=>{const offer={from:me.uid,to:targetUid,offeredTokens:0,offeredGreens:[],requestedTokens:0,requestedGreens:[],status:'pending',ts:firebase.firestore.FieldValue.serverTimestamp()};await db.collection('offers').add(offer);alert('Offer sent');});}requireAuth(async (u)=>{db.collection('offers').where('to','==',u.uid).onSnapshot(snap=>{const el=document.getElementById('offers');el.innerHTML='';snap.forEach(d=>{const o=d.data();const id=d.id;const div=document.createElement('div');div.className='msg';div.innerHTML=`<div><strong>Offer from ${o.from}</strong> <div class="small">status:${o.status}</div><div><button onclick="acceptOffer('${id}')">Accept</button> <button onclick="declineOffer('${id}')">Decline</button></div></div>`;el.appendChild(div);});});});async function acceptOffer(id){const doc=await db.collection('offers').doc(id).get();const o=doc.data();if(!o) return;const fromRef=db.collection('users').doc(o.from);const toRef=db.collection('users').doc(o.to);await db.runTransaction(async t=>{const f=(await t.get(fromRef)).data();const to=(await t.get(toRef)).data();t.update(fromRef,{tokens:(f.tokens||0) - (o.offeredTokens||0) + (o.requestedTokens||0)});t.update(toRef,{tokens:(to.tokens||0) - (o.requestedTokens||0) + (o.offeredTokens||0)});t.update(db.collection('offers').doc(id),{status:'accepted'});});alert('Accepted (demo)');}async function declineOffer(id){await db.collection('offers').doc(id).update({status:'declined'});};</script></body></html>